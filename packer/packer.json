{
    "variables": {
        "build_tag": "",
        "build_number": "",
        "output_manifest_file": "packer-manifest.json",
        "instance_profile": "",
        "branch": "",
        "component": "wordpress-mysql-image",
        "region": "ap-southeast-2",
        "vpc_id": "",
        "subnet_id": "",
        "environment": ""
    },

    "builders": [
        {
            "type": "amazon-ebs",
            "region": "{{user `region`}}",
            "instance_type": "t3.medium",
            "ssh_username": "ec2-user",
            "iam_instance_profile": "{{user `instance_profile`}}",
            "ami_name": "{{user `component`}}-{{isotime | clean_resource_name}}",
            "ami_description": "{{user `component`}}-{{isotime | clean_resource_name}}",
            "vpc_id": "{{user `vpc_id`}}",
            "subnet_id": "{{user `subnet_id`}}",
            "source_ami_filter": {
                "filters": {
                  "virtualization-type": "hvm",
                  "name": "amzn2-ami-hvm-2.0.*",
                  "root-device-type": "ebs"
                },
                "owners": [
                  "amazon"
                ],
                "most_recent": true
            },
            "tags": {
                "Name": "{{user `component`}}-{{isotime | clean_resource_name}}",
                "branch": "{{user `branch`}}",
                "build_region": "{{.BuildRegion}}",
                "component": "{{user `component`}}",
                "date": "{{isotime}}",
                "source_ami": "{{.SourceAMI}}"
              },
              "run_tags": {
                "Name": "packer-build-{{user `component`}}-{{user `branch`}}"
              }
        }
    ],
    
    "provisioners": [
      {
        "type": "ansible-local",
        "extra_arguments": ["--become"],
        "playbook_file": "packer/ansible/playbook.yml"
      }
    ],

    "post-processors": [
        {
          "output": "manifest.json",
          "strip_path": true,
          "type": "manifest"
        }
    ]
}